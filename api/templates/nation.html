{% extends "base.html" %}
{% block title %}{{ data.name }} | Town Profile{% endblock %}

{% block content %}
<a href="/nations">‚Üê Back to nations</a>

<div class="town-profile-container">
    <div class="town-header">
        <h1>{{ data.name }}</h1>
        {% if data.board %}<div class="small">{{ data.board }}</div>{% endif %}
    </div>

    <div class="town-body">
        <!-- Left: Map -->
        <div class="map-container">
            <iframe 
                src="https://earthpol.com/map/#world:{{ data.coordinates.spawn.x | round(0, 'floor') }}:0:{{ data.coordinates.spawn.z | round(0, 'floor') }}:300:0:0:0:1:flat"
                width="100%" height="100%" style="border:0;" allowfullscreen
                loading="lazy">
            </iframe><br><br><br>
            <img loading="lazy"
                 src="https://cdn.earthpol.com/nations/{{ data.name }}.png"
                 alt="{{ data.name }} flag"
                 style="width: 100%; height: auto; max-height: 300px; object-fit: contain;"
                 onerror="this.style.display='none'; document.querySelector('.abcdefg').style.display='none';">
            <p style="text-align: center;" class="abcdefg"><em>{{ data.name }}'s Flag</em></p>
        </div>

        <!-- Right: Info -->
        <div class="info-container">
            <div class="section">
                <h2>Timestamps</h2>
                <p>Registered: {{ (data.timestamps.registered / 1000) | datetimeformat }}</p>
            </div>

            <div class="section">
                <h2>Leadership</h2>
                <p>King: 
                    <img src="https://api.mineatar.io/head/{{ data.king.uuid }}?scale=4&overlay=true" alt="{{ data.king.name }} head">
                    <a href="/players/{{ data.king.uuid }}">{{ data.king.name }}</a>
                </p>
                <p>Capital: <a href="/town/{{ data.capital.uuid }}">{{ data.capital.name }}</a></p>
                <p>Discord: 
                    {% if data.discord %}
                        <a href="{{ data.discord }}">{{ data.discord }}</a>
                    {% else %}
                        None
                    {% endif %}
                </p>
            </div>

            <div class="section">
                <h2>Status</h2>
                <p>
                    Open: {{ 'Yes' if data.status.isOpen else 'No' }}, 
                    Neutral: {{ 'Yes' if data.status.isNeutral else 'No' }}, 
                    Public: {{ 'Yes' if data.status.isPublic else 'No' }}
                </p>
            </div>

            <div class="section">
                <h2>Residents ({{ data.stats.numResidents }})</h2>
                {% if data.residents %}
                    {% set display = data.residents[:50] %}
                    {% for r in display %}
                        <a href="/players/{{ r.uuid }}">{{ r.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.residents|length > 50 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Towns ({{ data.stats.numTowns }})</h2>
                {% if data.residents %}
                    {% set display = data.towns[:50] %}
                    {% for r in display %}
                        <a href="/town/{{ r.uuid }}">{{ r.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.towns|length > 50 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Allies ({{ data.allies|length }})</h2>
                {% if data.allies %}
                    {% set display = data.allies[:10] %}
                    {% for t in display %}
                        <a href="/nation/{{ t.uuid }}">{{ t.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.allies|length > 10 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Enemies ({{ data.enemies|length }})</h2>
                {% if data.enemies %}
                    {% set display = data.enemies[:10] %}
                    {% for o in display %}
                        <a href="/nation/{{ o.uuid }}">{{ o.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.enemies|length > 10 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>
            
            <div class="section">
                <h2>Sanctioned ({{ data.sanctioned|length }})</h2>
                {% if data.sanctioned %}
                    {% set display = data.sanctioned[:10] %}
                    {% for o in display %}
                        <a href="/nation/{{ o.uuid }}">{{ o.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.sanctioned|length > 10 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Ranks</h2>
                {% for rank, members in data.ranks.items() %}
                    {% if members %}
                        <strong>{{ rank | capitalize }} ({{ members|length }}):</strong>
                        {% set display = members[:10] %}
                        {% for m in display %}
                            <a href="/players/{{ m.uuid }}">{{ m.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if members|length > 10 %}, ...{% endif %}
                        <br>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.town-profile-container {
    max-width: 2000px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    color: #e0e0e0;
}
.town-header h1 {
    font-size: 36px;
    margin: 0;
}
.town-header .small {
    font-size: 0.9em;
    color: #aaa;
    text-align: center;
}
.town-body {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
.map-container {
    flex: 10;
    height: 600px;
}
.info-container {
    flex: 13;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.section {
    background-color: #2e2e2e;
    padding: 15px;
    border-radius: 8px;
}
.section h2 {
    margin-top: 0;
    font-size: 18px;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
    margin-bottom: 10px;
}
.section img {
    width: 32px;
    height: 32px;
    vertical-align: middle;
    margin-right: 5px;
    border-radius: 4px;
}
a { color: #4da6ff; text-decoration: none; }
a:hover { color: #80c1ff; }
</style>
{% endblock %}
