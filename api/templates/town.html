{% extends "base.html" %}
{% block title %}{{ data.name }} | Town Profile{% endblock %}

{% block content %}
<a href="/towns">‚Üê Back to towns</a>

<div class="town-profile-container">
    <div class="town-header">
        <h1>{{ data.name }}</h1>
        {% if data.board %}<div class="small">{{ data.board }}</div>{% endif %}
    </div>

    <div class="town-body">
        <!-- Left: Map -->
        <div class="map-container">
            {% if data
               and data.coordinates
               and data.coordinates.spawn
               and data.coordinates.spawn.x is not none
               and data.coordinates.spawn.z is not none %}
            <iframe 
                src="https://earthpol.com/map/#world:{{ data.coordinates.spawn.x | round(0, 'floor') }}:0:{{ data.coordinates.spawn.z | round(0, 'floor') }}:300:0:0:0:1:flat"
                width="100%"
                height="100%"
                style="border:0;"
                allowfullscreen
                loading="lazy">
            </iframe>
            {% else %}
            <p>No spawn set.</p>
            {% endif %}
        </div>

        <!-- Right: Info -->
        <div class="info-container">
            <div class="section">
                <h2>Timestamps</h2>
                <p>Registered: {{ (data.timestamps.registered / 1000) | datetimeformat }}</p>
            </div>

            <div class="section">
                <h2>Leadership</h2>
                <p>Founder: {{ data.founder }}</p>
                <p>Mayor: 
                    <img src="https://api.mineatar.io/head/{{ data.mayor.uuid }}?scale=4&overlay=true" alt="{{ data.mayor.name }} head">
                    <a href="/players/{{ data.mayor.uuid }}">{{ data.mayor.name }}</a>
                </p>
                <p>Nation status: 
                    {% if data.nation and data.nation.name %}
                        {% if data.status.isCapital %}
                            Capital of
                            <a href="/nations/{{ data.nation.uuid }}">{{ data.nation.name }}</a>
                        {% else %}
                            Town in
                            <a href="/nations/{{ data.nation.uuid }}">{{ data.nation.name }}</a>
                        {% endif %}
                    {% else %}
                        Town not in a nation
                    {% endif %}
                </p>
            </div>

            <div class="section">
                <h2>Status</h2>
                <p>
                    Open: {{ 'Yes' if data.status.isOpen else 'No' }}, 
                    Neutral: {{ 'Yes' if data.status.isNeutral else 'No' }}, 
                    Ruined: {{ 'Yes' if data.status.isRuined else 'No' }}, 
                    For Sale: {{ 'Yes' if data.status.isForSale else 'No' }}, 
                    Has Nation: {{ 'Yes' if data.status.hasNation else 'No' }}
                </p>
            </div>

            <div class="section">
                <h2>Town Blocks</h2>
                <p>{{ data.stats.numTownBlocks }} / {{ data.stats.maxTownBlocks }} (+{{ data.stats.bonusBlocks }})</p>
            </div>

            <div class="section">
                <h2>Residents ({{ data.stats.numResidents }})</h2>
                {% if data.residents %}
                    {% set display = data.residents[:50] %}
                    {% for r in display %}
                        <a href="/players/{{ r.uuid }}">{{ r.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.residents|length > 50 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Trusted ({{ data.trusted|length }})</h2>
                {% if data.trusted %}
                    {% set display = data.trusted[:10] %}
                    {% for t in display %}
                        <a href="/players/{{ t.uuid }}">{{ t.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.trusted|length > 10 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Outlaws ({{ data.outlaws|length }})</h2>
                {% if data.outlaws %}
                    {% set display = data.outlaws[:10] %}
                    {% for o in display %}
                        <a href="/players/{{ o.uuid }}">{{ o.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% if data.outlaws|length > 10 %}, ...{% endif %}
                {% else %}
                    None
                {% endif %}
            </div>

            <div class="section">
                <h2>Ranks</h2>
                {% for rank, members in data.ranks.items() %}
                    {% if members %}
                        <strong>{{ rank | capitalize }} ({{ members|length }}):</strong>
                        {% set display = members[:10] %}
                        {% for m in display %}
                            <a href="/players/{{ m.uuid }}">{{ m.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if members|length > 10 %}, ...{% endif %}
                        <br>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.town-profile-container {
    max-width: 2000px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    color: #e0e0e0;
}
.town-header h1 {
    font-size: 36px;
    margin: 0;
}
.town-header .small {
    font-size: 0.9em;
    color: #aaa;
    text-align: center;
}
.town-body {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
.map-container {
    flex: 10;
    height: 600px;
}
.info-container {
    flex: 13;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.section {
    background-color: #2e2e2e;
    padding: 15px;
    border-radius: 8px;
}
.section h2 {
    margin-top: 0;
    font-size: 18px;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
    margin-bottom: 10px;
}
.section img {
    width: 32px;
    height: 32px;
    vertical-align: middle;
    margin-right: 5px;
    border-radius: 4px;
}
a { color: #4da6ff; text-decoration: none; }
a:hover { color: #80c1ff; }
</style>
{% endblock %}
