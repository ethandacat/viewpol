{% extends "base.html" %}
{% block title %}Nations | ViewPol{% endblock %}

{% block content %}
<a href="/">Back to home</a>
<h1>Nations</h1>

<div class="search-bar">
    <form id="search-form">
        <input type="text" id="search-input" placeholder="Search nations..." value="{{ query }}">
        <button type="submit">Search</button>
    </form>
</div>

<div id="nation-grid-container">
    <div class="grid nationgrid" style="visibility: hidden;">
        {% for n in players %}
        <div class="player-card" data-name="{{ n.name }}">
            <img loading="lazy"
                 src="https://cdn.earthpol.com/nations/{{ n.name.replace(' ', '_') }}.png"
                 alt="{{ n.name }} flag"
                 style="width: 100%; height: auto; max-height: 180px; object-fit: contain;"
                 onerror="this.style.display='none';">
            <a href="/nations/{{ n.uuid }}" style="display: block; text-align: center;">{{ n.name }}</a>
        </div>
        {% endfor %}
    </div>
</div>

<div class="pagination" id="pagination-controls"></div>

<script>
const NATIONS_PER_PAGE = 20;

// Get initial page from Jinja2
let currentPage = {{ page }};

document.addEventListener('DOMContentLoaded', async () => {
    const gridContainer = document.querySelector('.nationgrid');
    const allCards = Array.from(document.querySelectorAll('.player-card'));

    const flagChecks = allCards.map(card => {
        const img = card.querySelector('img');
        const url = img.src;
        return new Promise(resolve => {
            const testImg = new Image();
            testImg.onload = () => resolve({ card, hasFlag: true });
            testImg.onerror = () => resolve({ card, hasFlag: false });
            testImg.src = url;
        });
    });

    const results = await Promise.all(flagChecks);

    let nations = results.map(r => ({
        name: r.card.dataset.name,
        element: r.card,
        hasFlag: r.hasFlag
    }));

    function sortNations(list) {
        return list.sort((a, b) => {
            if (a.hasFlag !== b.hasFlag) return b.hasFlag - a.hasFlag;
            return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
        });
    }

    const totalPages = Math.ceil(nations.length / NATIONS_PER_PAGE);

    function renderPage(page) {
        const start = (page - 1) * NATIONS_PER_PAGE;
        const end = start + NATIONS_PER_PAGE;
        const pageItems = nations.slice(start, end);

        gridContainer.innerHTML = '';
        pageItems.forEach(n => gridContainer.appendChild(n.element));

        renderPaginationControls(page);
    }

    function renderPaginationControls(page) {
        const container = document.getElementById('pagination-controls');
        container.innerHTML = '';
    
        // Always show 5 items: First, Prev, Numbers (1-3), Next, Last
        const controls = [];
    
        // 1. First (always shown, disabled if page === 1)
        const first = document.createElement('a');
        first.href = '#';
        first.textContent = '« First';
        first.className = page === 1 ? 'disabled' : '';
        if (page !== 1) {
            first.onclick = e => { e.preventDefault(); goToPage(1); };
        }
        controls.push(first);
    
        // 2. Prev (always shown, disabled if page === 1)
        const prev = document.createElement('a');
        prev.href = '#';
        prev.textContent = '‹ Prev';
        prev.className = page === 1 ? 'disabled' : '';
        if (page > 1) {
            prev.onclick = e => { e.preventDefault(); goToPage(page-1); };
        }
        controls.push(prev);
    
        // 3-5. Three number links (smart positioning to fill exactly 3 slots)
        const startNum = Math.max(1, Math.min(totalPages - 2, page - 1));
        for (let i = 0; i < 3; i++) {
            const numPage = startNum + i;
            if (numPage <= totalPages) {
                const pageLink = document.createElement('a');
                pageLink.href = '#';
                pageLink.textContent = numPage;
                if (numPage === page) pageLink.className = 'current';
                pageLink.onclick = e => { e.preventDefault(); goToPage(numPage); };
                controls.push(pageLink);
            } else {
                // Filler if fewer than 3 pages
                const filler = document.createElement('span');
                filler.textContent = '...';
                filler.className = 'filler';
                controls.push(filler);
            }
        }
    
        // 6. Next (always shown, disabled if page === totalPages)
        const next = document.createElement('a');
        next.href = '#';
        next.textContent = 'Next ›';
        next.className = page === totalPages ? 'disabled' : '';
        if (page < totalPages) {
            next.onclick = e => { e.preventDefault(); goToPage(page+1); };
        }
        controls.push(next);
    
        // 7. Last (always shown, disabled if page === totalPages)
        const last = document.createElement('a');
        last.href = '#';
        last.textContent = 'Last »';
        last.className = page === totalPages ? 'disabled' : '';
        if (page !== totalPages) {
            last.onclick = e => { e.preventDefault(); goToPage(totalPages); };
        }
        controls.push(last);
    
        // Append all 7 controls (always exactly 7 items)
        controls.forEach(control => container.appendChild(control));
    }

    function goToPage(page) {
        currentPage = page;
        renderPage(currentPage);
    }

    document.getElementById('search-form').addEventListener('submit', e => {
        e.preventDefault();
        const query = document.getElementById('search-input').value.toLowerCase();
        nations = sortNations(results
            .filter(r => r.card.dataset.name.toLowerCase().includes(query))
            .map(r => ({ name: r.card.dataset.name, element: r.card, hasFlag: r.hasFlag }))
        );
        currentPage = {{ page }}; // reset to initial page from server
        renderPage(currentPage);
    });

    nations = sortNations(nations);
    renderPage(currentPage);

    gridContainer.style.visibility = 'visible';
});
</script>

{% endblock %}
