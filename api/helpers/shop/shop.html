{% extends "base.html" %}

{% set MINECRAFT_COLORS = {
    "black": "#000000",
    "dark_blue": "#0000AA",
    "dark_green": "#00AA00",
    "dark_aqua": "#00AAAA",
    "dark_red": "#AA0000",
    "dark_purple": "#AA00AA",
    "gold": "#FFAA00",
    "gray": "#AAAAAA",
    "dark_gray": "#555555",
    "blue": "#5555FF",
    "green": "#55FF55",
    "aqua": "#55FFFF",
    "red": "#FF5555",
    "light_purple": "#FF55FF",
    "yellow": "#FFFF55",
    "white": "#FFFFFF"
} %}


{% block title %}{{ data.item.item.replace("_", " ")|title }} Shop | ViewPol{% endblock %}

{% block content %}
<a href="/shops">‚Üê Back to shops</a>



<div class="town-profile-container">
    <div class="town-header">
        <div class="small">{{ data.type|title }}</div>
        <h1>{{ data.item.item.replace("_", " ")|title }}</h1>
    </div>

    <div class="town-body">
        <!-- Left: Map -->
        <div class="map-container">
            <iframe 
                src="https://earthpol.com/map/#world:{{ data.location.x | round(0, 'floor') }}:0:{{ data.location.z | round(0, 'floor') }}:300:0:0:0:1:flat"
                width="100%"
                height="100%"
                style="border:0;"
                allowfullscreen
                loading="lazy">
            </iframe>
            <img
                loading="lazy"
                src="/assets/item/minecraft_{{ data.item.item }}.png"
                alt="{{ data.item.item }} image"
                style="width:100%; height:auto; max-height:300px; object-fit:contain; image-rendering: pixelated;"
                onerror="this.style.display='none'"
            >
        </div>

        <!-- Right: Info -->
        <div class="info-container">
            <div class="section">
                <h2>Price</h2>
                <p>{{ data.price|round|int }}g per {{ data.item.amount }} items</p>
                <p>or {{ (data.price / data.item.amount)|round(2) }}g per item</p>
            </div>

            <div class="section">
                <h2>Owner</h2>
                <p>
                    <img src="https://api.mineatar.io/head/{{ data.owner }}?scale=4&overlay=true" alt="{{ username }} head">
                    <a href="/players/{{ data.owner }}">{{ username }}</a>
                </p>
            </div>

            <div class="section">
                <h2>Stock</h2>
                <p>
                    {% if data.type == "SELLING" %}
                        {% if data.stock == -1 or data.stock == 0 %}
                            Out of stock.
                        {% else %}
                            Stock: {{ data.stock }}
                        {% endif %}
                    {% else %}
                        {% if data.space == -1 or data.space == 0 %}
                            Out of space.
                        {% else %}
                            Space: {{ data.space }}
                        {% endif %}
                    {% endif %}
                </p>
            </div>
            <div class="section">
                <h2>Item Lore</h2>
                {% if data.item.meta and data.item.meta.lore %}
                    <ul class="item-lore">
                    {% for line in data.item.meta.lore %}
                        <li style="font-size: 0;">
                        {% if line.extra %}
                            {% for part in line.extra %}
                                <span style="
                                    color: {{ MINECRAFT_COLORS.get(part.color, '#FFFFFF') }};
                                    {% if part.bold %} font-weight: bold;{% endif %}
                                    {% if part.italic %} font-style: italic;{% endif %}
                                    {% if part.underlined %} text-decoration: underline;{% endif %}
                                    {% if part.strikethrough %} text-decoration: line-through;{% endif %}
                                    font-size: 1.5rem;
                                    margin: 0;
                                    padding: 0;
                                ">{{ part.text }}</span>
                            {% endfor %}
                        {% else %}
                            {{ line.text }}
                        {% endif %}
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>No lore.</p>
                {% endif %}
            </div>
            <div class="section">
                <h2>Item</h2>
                <p>Type: <code>minecraft:{{ data.item.item|lower }}</code></p>
                <p>Amount: {{ data.item.amount }}</p>
                {% set all_enchants = {} %}
                
                {% if data.item.meta %}
                    {% if data.item.meta.enchants %}
                        {% for k, v in data.item.meta.enchants.items() %}
                            {% set _ = all_enchants.update({k: v}) %}
                        {% endfor %}
                    {% endif %}
                    {% if data.item.meta['stored-enchants'] %}
                        {% for k, v in data.item.meta['stored-enchants'].items() %}
                            {% set _ = all_enchants.update({k: v}) %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
                
                {% if all_enchants %}
                    <p><strong>Enchants:</strong></p>
                    <ul>
                        {% for ench, lvl in all_enchants.items() %}
                            <li>{{ ench.replace("minecraft:", "").replace("_"," ")|title }} {{ lvl }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            {% if data.item.meta and "BOOK" in data.item.meta["meta-type"] %}
            <div class="section">
                <h2>Book Preview</h2>
                <p class="bgl" style="font-weight: bold;">{{ data.item.meta.title }}</p>
                <p class="bgl">{{ data.item.meta.pages[0] }}...</p>
            </div>
            {% endif %}
        <div>
    </div>
</div>

<style>
.bgl {
    font-family: 'Minecraft', monospace;
    line-height: 1em;
    font-size: 1rem;
}
.item-lore {
    list-style: none;
    padding-left: 0;
    margin: 0;
    font-family: 'Minecraft', monospace;
    line-height: 1.2em;
    font-size: 1.5rem;
}
.item-lore li {
    margin-bottom: 2px;
}
.town-profile-container {
    max-width: 2000px;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    color: #e0e0e0;
}
.town-header h1 {
    font-size: 36px;
    margin: 0;
}
.town-header .small {
    font-size: 0.9em;
    color: #aaa;
    text-align: center;
}
.town-body {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
.map-container {
    flex: 10;
    height: 600px;
}
.info-container {
    flex: 13;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.section {
    background-color: #2e2e2e;
    padding: 15px;
    border-radius: 8px;
}
.section h2 {
    margin-top: 0;
    font-size: 18px;
    border-bottom: 1px solid #444;
    padding-bottom: 5px;
    margin-bottom: 10px;
}
.section img {
    width: 32px;
    height: 32px;
    vertical-align: middle;
    margin-right: 5px;
    border-radius: 4px;
}
a { color: #4da6ff; text-decoration: none; }
a:hover { color: #80c1ff; }
</style>
{% endblock %}
